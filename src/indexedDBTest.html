<!doctype html>
<html>

<head>
	<link rel="stylesheet" type="text/less" href="css/main.less" />
	<script type="text/javascript" src="libs/lodash/lodash.js"></script>
	<script type="text/javascript" src="libs/jquery/jquery.js"></script>
	<script>
		$(function () {
			$('#createDb').click(createDb);
			$('#initStore').click(initStore);
			$('#getAllDbs').click(getAllDbs);
			$('#getDbSize').click(getDbSize);
			$('#deleteDb').click(deleteDb);

			var db;

			return void(0);

			function initStore() {
				if (!db) {
					openDatabase()
						.then(doInitStore);
				} else {
					doInitStore(db);
				}
			}

			function doInitStore(dbOld) {
				dbOld.close();
				var openRequest = indexedDB.open(dbOld.name, dbOld.version + 1);

				openRequest.onerror = function (e) {
					console.log("Database error: " + e.target.errorCode);
				};

				openRequest.onsuccess = function () {
					db = openRequest.result;
				};

				openRequest.onupgradeneeded = function (e) {
					var storeName = 'employees';

					var db = e.currentTarget.result;

					if (db.objectStoreNames.contains(storeName)) {
						console.log('object store', storeName, 'existed');
						return;
					}

					var employeeStore = db.createObjectStore("employees", {
						keyPath: "id"
					});

					employeeStore.createIndex("stateIndex", "state", {
						unique: false
					});
					employeeStore.createIndex("emailIndex", "email", {
						unique: true
					});
					employeeStore.createIndex("zipCodeIndex", "zip_code", {
						unique: false
					})

					console.log('init store success');
				};
			}

			function deleteDb() {
				var dbName = getDbName();
				if (!dbName) {
					return;
				}

				var deleteDbRequest = indexedDB.deleteDatabase(dbName);

				deleteDbRequest.onsuccess = function (event) {
					console.log('database deleted successfully');
				};

				deleteDbRequest.onerror = function (e) {
					console.log("Database error: " + e.target.errorCode);
				};
			}

			function createDb() {
				openDatabase()
					.then(function () {
						console.log('create db success');
					}, function () {
						consol.elog('create db failed')
					});
			}

			function getDbSize() {
				var storesizes = new Array();

				openDatabase()
					.then(function () {
						var stores = db.objectStoreNames;
						var PromiseArray = [];
						for (var i = 0; i < stores.length; i++) {
							PromiseArray.push(getObjectStoreData(stores[i]));
						}
						Promise.all(PromiseArray).then(function () {
							console.table(storesizes);
						});
					});

				return void(0);

				function getObjectStoreData(storename) {
					return new Promise(function (resolve, reject) {
						var trans = db.transaction(storename, IDBTransaction.READ_ONLY);
						var store = trans.objectStore(storename);
						var items = [];
						trans.oncomplete = function (evt) {
							var szBytes = toSize(items);
							var szMBytes = (szBytes / 1024 / 1024).toFixed(2);
							storesizes.push({
								'Store Name': storename,
								'Items': items.length,
								'Size': szMBytes + 'MB (' + szBytes + ' bytes)'
							});
							resolve();
						};
						var cursorRequest = store.openCursor();
						cursorRequest.onerror = function (error) {
							reject(error);
						};
						cursorRequest.onsuccess = function (evt) {
							var cursor = evt.target.result;
							if (cursor) {
								items.push(cursor.value);
								cursor.continue();
							}
						}
					});
				}

				function toSize(items) {
					var size = 0;
					for (var i = 0; i < items.length; i++) {
						var objectSize = JSON.stringify(items[i]).length;
						size += objectSize * 2;
					}
					return size;
				}

			}

			function openDatabase(dbName) {
				return new Promise(function (resolve, reject) {
					//prompt for DB name
					var dbname = dbName || getDbName();

					if (dbname !== null) {
						var request = window.indexedDB.open(dbname);
						request.onsuccess = function (event) {
							db = event.target.result;
							resolve(db);
						};
					}

				});
			}

			function getDbName() {
				return prompt('Please enter your Database Name', '');
			}

			function getAllDbs() {
				var request = indexedDB.webkitGetDatabaseNames();
				request.onsuccess = function (e) {
					console.log('dbs');
					console.table(e.target);
				};
				request.onerror = function (e) {
					console.log('get dbs failed', e);
				}
			}

		});
	</script>
</head>

<body>
	<h1>Test Indexed DB</h1>
	<div>
		<button id="createDb">create db</button>
		<button id="initStore">init store</button>
		<button id="getAllDbs">get all dbs</button>
		<button id="getDbSize">get db size</button>
		<button id="deleteDb">delete db</button>
	</div>
</body>

</html>