<!doctype html>
<html>

<head>
	<script type="text/javascript" src="libs/babel-polyfill/polyfill.js"></script>
	<link rel="stylesheet" type="text/less" href="css/main.less" />
	<script type="text/javascript" src="libs/lodash/lodash.js"></script>
	<script type="text/javascript" src="libs/jquery/jquery.js"></script>
	<script type="text/javascript" src="libs/less/less.js"></script>
	<script type="text/javascript" src="libs/guid.js"></script>

	<script>
		$(function() {

			$('#createDb').click(createDb);
			$('#initStore').click(initStore);
			$('#deleteStore').click(deleteStore);
			$('#getAllDbs').click(getAllDbs);
			$('#getDbSize').click(getDbSize);
			$('#deleteDb').click(deleteDb);

			$('#count').click(count);
			$('#clear').click(clear);
			$('#insertEmployee').click(insertEmployee);
			$('#insert50W').click(insert50W);
			$('#insert50W2').click(insert50W2);
			$('#insert50W3').click(insert50W3);

			$('#get').click(getById);
			$('#delete').click(deleteById);

			$('#start').click(start);

			var row = 0;
			var data;
			var db;
			var storeName = 'employees';
			var w50 = 5000000;

			var jobs = {
				reader: 'reader',
				writer: 'writer',
			};

			var page = 1;
			var size = 0.2; //1; // M
			var dbName = 'test2';
			var job = jobs.reader;
			var records = 20000;

			var result = $('#result');

			$('#page')
				.change(function() {
					page = $(this).val();
				})
				.val(page);

			$('#size')
				.change(function() {
					size = $(this).val();
				})
				.val(size);

			$('#db')
				.change(function() {
					dbName = $(this).val();
				})
				.val(dbName);

			$('#records')
				.change(function() {
					records = $(this).val();
				})
				.val(records);

			$('input[name="job"]')
				.change(function() {
					job = $('input[name="job"]:checked').val();
				});

			$('input[name="job"][value=reader]')
				.attr('checked', true);

			return void(0);

			function start() {
				if (job === jobs.reader) {
					read();
				} else {
					write();
				}
			}

			function read() {
				var success = 0;
				var failed = 0;

				addEventListener("storage", function(e) {
					if (e.key == page) {
						var id = e.newValue;
						doGetById(id)
							.then(function(data) {
								if (data && id === data.id) {
									success++;
								} else {
									failed++;
								}

								console.log(success, failed, success / (success + failed));
							});
					}
				});
			}

			function write() {
				getDb(function() {
					console.time('write');
					doWrite(0);
				});
			}

			function doWrite(order) {
				if (order < records) {
					var data = createEmployee(order);
					doInsertEmployee(data)
						.then(function() {
							localStorage.setItem(page, data.id);
							doWrite(order + 1);
						}, function() {
							console.timeEnd('write');
						});
				} else {
					console.timeEnd('write');
				}
			}


			function getGuid() {
				return Guid.NewGuid().ToString();
			}

			function deleteById() {
				getDb(function() {
					var store = getStoreReadWrite();

					var key = 'DeleteById';
					console.time(key);

					var id = randomId();

					var request = store.delete(id);
					logRequestResult(request, key)
						.then(function(data) {
							console.log(data);
							doGetById(id);
						});
				});
			}

			function getById() {
				return doGetById();
			}

			function doGetById(id) {
				return getDb(function() {
					var store = getStoreReadOnly();

					var key = 'GetById';
					console.time(key);

					id = id || randomId();

					var request = store.get(id);
					return logRequestResult(request, key)
						.then(function(data) {
							// console.log(id, data);
							return data;
						});
				});
			}

			function count() {
				getDb(function() {
					var key = 'Count';

					var store = getStoreReadOnly();
					var request = store.count();

					console.time(key);

					logRequestResult(request, key)
						.then(function(count) {
							console.log(count, 'employees');
						});
				});
			}

			function clear() {
				getDb(function() {
					var store = getStoreReadWrite();

					var key = 'Clear';
					console.time(key);

					var request = store.clear();
					logRequestResult(request, key);
				});
			}

			function logRequestResult(request, description) {
				return new Promise(function(resolve, reject) {
					request.onsuccess = function(e) {
						console.timeEnd(description);

						console.log(description, 'success');
						resolve(e.currentTarget.result);
					}

					request.onerror = function(e) {
						console.log(description, 'failed', e);
						reject();
					}
				});
			}

			function insertEmployee() {
				getDb(function() {
					doInsertEmployee(createEmployee(0));
				});
			}

			function createEmployee(order) {
				return {
					"id": getGuid(), // "E" + order,
					// "first_name": "Jane",
					// "last_name": "Doh",
					// "email": "jane.doh@somedomain.com_" + order,
					"street": getData(),
					// "city": "Washington D.C.",
					// "state": "DC",
					// "zip_code": "20500",
				};
			}

			function doInsertEmployee(employee) {
				return new Promise(function(resolve, reject) {
					var store = getStoreReadWrite();

					var key = 'Add';
					console.time(key);

					var request = store.add(employee);

					logRequestResult(request, key)
						.then(resolve, reject);
				});
			}

			function getStoreReadWrite() {
				var transaction = db.transaction(storeName, 'readwrite');
				var store = transaction.objectStore(storeName);
				return store;
			}

			function getStoreReadOnly() {
				var transaction = db.transaction(storeName, 'readonly');
				var store = transaction.objectStore(storeName);
				return store;
			}

			// async function insert50W2() {
			// 	getDb(function () {
			// 		var employees = [];
			// 		var i = 0;

			// 		for (i = w50; i > 0; i--) {
			// 			employees.push(createEmployee(i));
			// 		}

			// 		var store = getStoreReadWrite();
			// 		console.time('insert 50w 2');
			// 		for (i = w50; i > 0; i--) {
			// 			await doInsertEmployee(employees[i]);
			// 		}
			// 		console.timeEnd('insert 50w 2');
			// 	});
			// }

			function insert50W() {
				getDb(function() {
					console.time('insert 50w');
					doInsert50W(0);
				});
			}

			function doInsert50W(order) {
				if (order < w50) {
					doInsertEmployee(createEmployee(order))
						.then(function() {
							doInsert50W(order + 1);
						}, function() {
							console.timeEnd('insert 50w');
						});
				} else {
					console.timeEnd('insert 50w');
				}
			}


			function insert50W3() {
				getDb(function() {
					console.time('insert 50w');
					var data = {
						data: getData(),
					};
					doInsert50W3(0, data);
				});
			}

			function doInsert50W3(order, data) {
				if (order < w50) {
					// data.data = order;
					data.id = getGuid();
					doInsertEmployee(data)
						.then(function() {
							doInsert50W3(order + 1, data);
						}, function() {
							console.timeEnd('insert 50w');
						});
				} else {
					console.timeEnd('insert 50w');
				}
			}

			function getDb(cb) {
				if (!db) {
					return openDatabase(dbName)
						.then(cb);
				} else {
					return cb(db);
				}
			}

			function deleteStore() {
				getDb(doDeleteStore);
			}

			function doDeleteStore(dbOld) {
				upgradeVersion(dbOld, function(dbNew) {
					try {
						dbNew.deleteObjectStore(storeName);
						console.log('delete store success');
					} catch (e) {
						console.error(e);
					}
				});
			}

			function initStore() {
				getDb(doInitStore);
			}

			function upgradeVersion(dbOld, upgrade) {
				dbOld.close();
				var openRequest = indexedDB.open(dbOld.name, dbOld.version + 1);

				openRequest.onerror = function(e) {
					console.log("Database error: " + e.target.errorCode);
				};

				openRequest.onsuccess = function(e) {
					db = e.currentTarget.result;
				};

				openRequest.onupgradeneeded = function(e) {
					upgrade(e.currentTarget.result);
				}
			}

			function doInitStore(dbOld) {
				upgradeVersion(dbOld, function(dbNew) {
					try {
						if (dbNew.objectStoreNames.contains(storeName)) {
							console.log('object store', storeName, 'existed');
							return;
						}

						var employeeStore = dbNew.createObjectStore(storeName, {
							keyPath: "id",
							autoIncrement: true
						});

						var employeeStore = dbNew.createObjectStore(storeName, {
							keyPath: "id"
						});

						// employeeStore.createIndex("stateIndex", "state", {
						// 	unique: false
						// });
						// employeeStore.createIndex("emailIndex", "email", {
						// 	unique: true
						// });
						// employeeStore.createIndex("zipCodeIndex", "zip_code", {
						// 	unique: false
						// })

						console.log('init store success');
					} catch (e) {
						console.error(e);
					}
				});
			}

			function deleteDb() {
				var dbName = getDbName();
				if (!dbName) {
					return;
				}

				var deleteDbRequest = indexedDB.deleteDatabase(dbName);

				deleteDbRequest.onsuccess = function(event) {
					console.log('database deleted successfully');
				};

				deleteDbRequest.onerror = function(e) {
					console.log("Database error: " + e.target.errorCode);
				};
			}

			function createDb() {
				openDatabase()
					.then(function() {
						console.log('create db success');
					}, function() {
						consol.elog('create db failed')
					});
			}

			function getDbSize() {
				var storesizes = new Array();

				openDatabase()
					.then(function() {
						var stores = db.objectStoreNames;
						var PromiseArray = [];
						for (var i = 0; i < stores.length; i++) {
							PromiseArray.push(getObjectStoreData(stores[i]));
						}
						Promise.all(PromiseArray).then(function() {
							console.table(storesizes);
						});
					});

				return void(0);

				function getObjectStoreData(storename) {
					return new Promise(function(resolve, reject) {
						var trans = db.transaction(storename, IDBTransaction.READ_ONLY);
						var store = trans.objectStore(storename);
						var items = [];
						trans.oncomplete = function(evt) {
							var szBytes = toSize(items);
							var szMBytes = (szBytes / 1024 / 1024).toFixed(2);
							storesizes.push({
								'Store Name': storename,
								'Items': items.length,
								'Size': szMBytes + 'MB (' + szBytes + ' bytes)'
							});
							resolve();
						};
						var cursorRequest = store.openCursor();
						cursorRequest.onerror = function(error) {
							reject(error);
						};
						cursorRequest.onsuccess = function(evt) {
							var cursor = evt.target.result;
							if (cursor) {
								items.push(cursor.value);
								cursor.continue();
							}
						}
					});
				}

				function toSize(items) {
					var size = 0;
					for (var i = 0; i < items.length; i++) {
						var objectSize = JSON.stringify(items[i]).length;
						size += objectSize * 2;
					}
					return size;
				}

			}

			function openDatabase(dbName) {
				return new Promise(function(resolve, reject) {
					//prompt for DB name
					var dbname = dbName || getDbName();

					if (dbname !== null) {
						var request = window.indexedDB.open(dbname);
						request.onsuccess = function(event) {
							db = event.target.result;
							resolve(db);
						};
					}

				});
			}

			function getDbName() {
				return dbName || prompt('Please enter your Database Name', '');
			}

			function getAllDbs() {
				var request = indexedDB.webkitGetDatabaseNames();
				request.onsuccess = function(e) {
					console.log('dbs');
					console.table(e.target);
				};
				request.onerror = function(e) {
					console.log('get dbs failed', e);
				}
			}

			function getData() {
				return data ||
					(data = createData());
			}

			function createData() {
				var n = Math.floor(1024 / 2 * size - 30);
				var data = new Array(n);
				for (i = 0; i < n; i++) {
					data[i] = i;
				}
				return data.join('x').substring(0, n);
			}

			function randomId() {
				return Math.floor(Math.random() * 100000);
			}

		});
	</script>
</head>

<body>
	<h1>Test Indexed DB</h1>
	<div>
		<div class="panel">
			<button id="getAllDbs">get all dbs</button>
			<button id="createDb">create db</button>
			<button id="getDbSize">get db size</button>
			<button id="deleteDb">delete db</button>
		</div>
		<div class="panel">
			<button id="initStore">init store</button>
			<button id="deleteStore">delete store</button>
		</div>
		<div class="panel">
			<button id="count">count</button>
			<button id="clear">clear</button>
			<button id="insertEmployee">insert employee</button>
			<button id="insert50W">insert 50W</button>
			<button id="insert50W2">insert 50W 2</button>
			<button id="insert50W3">insert 50W 3</button>
		</div>
		<div class="panel">
			<button id="get">get</button>
			<button id="search">search</button>
			<button id="delete">delete</button>
		</div>

		<div class="panel form">
			<div class="row">
				<label for="page">page:</label><input type="text" id="page">
			</div>
			<div class="row">
				<label for="db">db:</label><input type="text" id="db">
			</div>
			<div class="row">
				<label for="size">recordSize(kb):</label><input type="text" id="size">
			</div>
			<div class="row">
				<label for="records">records:</label><input type="text" id="records">
			</div>
			<div class="row">
				<label>job:</label>
				<input type="radio" radiogroup="job" name="job" value="reader" id="reader"><label for="job">reader</label>
				<input type="radio" radiogroup="job" name="job" value="writer" id="writer"><label for="writer">writer</label>
			</div>
			<div class="row">
				<button id="start">start</button>
			</div>
			<div class="row" id="result"></div>
		</div>
	</div>
</body>

</html>
