<!doctype html>
<html>

<head>
	<link rel="stylesheet" type="text/less" href="css/main.less" />
	<script type="text/javascript" src="libs/lodash/lodash.js"></script>
	<script type="text/javascript" src="libs/jquery/jquery.js"></script>
	<script type="text/javascript" src="js/indexedDBWrapper.js"></script>
	<script type="text/javascript">
		$(function () {
			'use strict';

			var localDatabase = window;

			var db;
			var dbName = 'test1';
			var version = 1;

			runTest();

			return void(0);

			function runTest() {
				// Promise.resolve()
				// 	.then(deleteDatabase)
				// 	.then(createObjectStore)
				// 	.then(createIndex);

				Promise.resolve()
					.then(deleteDatabase)
					.then(test);
			}

			function test() {
				return new Promise(function (resolve, reject) {
					var openRequest = indexedDB.open(dbName, 3);

					openRequest.onerror = function (e) {
						console.log("Database error: " + e.target.errorCode);
						reject();
					};

					openRequest.onsuccess = function (event) {
						db = openRequest.result;
						resolve();
					};

					openRequest.onupgradeneeded = function (evt) {
						var employeeStore = evt.currentTarget.result.createObjectStore("employees", {
							keyPath: "id"
						});

						employeeStore.createIndex("stateIndex", "state", {
							unique: false
						});
						employeeStore.createIndex("emailIndex", "email", {
							unique: true
						});
						employeeStore.createIndex("zipCodeIndex", "zip_code", {
							unique: false
						})
					};
				});
			}

			function deleteDatabase() {
				return new Promise(function (resolve, reject) {
					var deleteDbRequest = indexedDB.deleteDatabase(dbName);

					deleteDbRequest.onsuccess = function (event) {
						console.log('database deleted successfully');
						resolve();
					};

					deleteDbRequest.onerror = function (e) {
						console.log("Database error: " + e.target.errorCode);
						reject();
					};
				});
			}

			function createObjectStore() {
				return new Promise(function (resolve, reject) {
					var openRequest = indexedDB.open(dbName, version++);

					openRequest.onerror = function (e) {
						console.log("Database error: " + e.target.errorCode);
						reject();
					};

					openRequest.onsuccess = function (event) {
						db = openRequest.result;
						resolve();
					};

					openRequest.onupgradeneeded = function (evt) {
						var employeeStore = evt.currentTarget.result.createObjectStore("employees", {
							keyPath: "id"
						});
					};
				});

			}

			function createIndex() {
				return new Promise(function (resolve, reject) {
					var openRequest = indexedDB.open(dbName, version++);

					openRequest.onerror = function (e) {
						console.log("Database error: " + e.target.errorCode);
						reject();
					};

					openRequest.onsuccess = function (event) {
						db = openRequest.result;
						resolve();
					};

					openRequest.onupgradeneeded = function (evt) {
						var employeeStore = evt.currentTarget.result.objectStore("employees");
						employeeStore.createIndex("stateIndex", "state", {
							unique: false
						});
						employeeStore.createIndex("emailIndex", "email", {
							unique: true
						});
						employeeStore.createIndex("zipCodeIndex", "zip_code", {
							unique: false
						})
					};

				});
			}
		});
	</script>
</head>

<body>
	<h1>Use Index DB</h1>
</body>

</html>